<!DOCTYPE html>
<html lang="az"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<body>
<main layout:fragment="content">

  <div class="container-fluid bg-light page-header py-5 mb-5">
    <div class="container text-center py-5">
      <h1 class="display-1">Rezervasiya</h1>
    </div>
  </div>

  <div class="container py-5">
    <div class="text-center mb-5">
      <h4 class="text-primary font-dancing-script">Ziyar…ôtinizi planla≈üdƒ±rƒ±n</h4>
      <h1 class="mb-0">Online rezervasiya edin</h1>
    </div>

    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8 col-sm-10">
        <!-- Uƒüur mesajƒ± (g√∂r√ºnm…ôz, modal √º√ß√ºn) -->
        <div th:if="${success}" id="successFlag" th:data-success="${success}"></div>

        <form th:action="@{/booking}" th:object="${reservation}" method="post"
              class="p-4 border rounded bg-light shadow-sm">

          <!-- Filial se√ß -->
          <div class="mb-3">
            <label class="form-label fw-bold">Filial se√ßin</label>
            <select id="branchSelect" class="form-select" required>
              <option value="">Se√ßin...</option>
              <option th:each="b : ${branches}" th:value="${b.id}" th:text="${b.name}"></option>
            </select>
          </div>

          <!-- Usta se√ß -->
          <div class="mb-3">
            <label class="form-label fw-bold">Usta se√ßin</label>
            <select id="staffSelect" class="form-select" disabled required>
              <option value="">Se√ßin...</option>
            </select>
          </div>

          <!-- Xidm…ôt se√ß -->
          <div class="mb-3">
            <label class="form-label fw-bold">Xidm…ôt se√ßin</label>
            <select id="serviceSelect" class="form-select" disabled required>
              <option value="">Se√ßin...</option>
            </select>
          </div>

          <!-- Tarix -->
          <div class="mb-3">
            <label class="form-label fw-bold">Tarix</label>
            <input type="date" id="dateInput" th:field="*{date}" class="form-control" required>
          </div>

          <!-- Vaxt -->
          <div class="mb-3">
            <label class="form-label fw-bold">Vaxt</label>
            <input type="time" th:field="*{startTime}" class="form-control" required>
          </div>

          <!-- M√º≈üt…ôri m…ôlumatlarƒ± -->
          <div class="mb-3">
            <label class="form-label fw-bold">Ad v…ô Soyad</label>
            <input type="text" th:field="*{customerName}" class="form-control"
                   placeholder="M…ôs: Lamiy…ô Budaqova" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Telefon</label>
            <input type="text" th:field="*{customerPhone}" class="form-control"
                   placeholder="+994..." required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">∆èlav…ô qeyd</label>
            <textarea th:field="*{notes}" class="form-control" rows="3"
                      placeholder="∆èlav…ô ist…ôk v…ô ya qeyd..."></textarea>
          </div>

          <!-- Gizli inputlar -->
          <input type="hidden" th:field="*{branchId}" id="branchIdHidden">
          <input type="hidden" th:field="*{staffId}" id="staffIdHidden">
          <input type="hidden" th:field="*{serviceId}" id="serviceIdHidden">

          <div class="text-center mt-4">
            <button class="btn btn-primary px-5 py-2" type="submit">
              <i class="bi bi-calendar-check me-2"></i>Rezerv et
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Uƒüurlu rezervasiya modali -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-success shadow">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="successModalLabel">Rezervasiya uƒüurlu</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Baƒüla"></button>
        </div>
        <div class="modal-body text-center">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 48px;"></i>
          <p class="mt-3 mb-0">Rezervasiyanƒ±z uƒüurla g√∂nd…ôrildi!<br>∆èn qƒ±sa zamanda sizinl…ô …ôlaq…ô saxlanƒ±lacaq.</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">Baƒüla</button>
        </div>
      </div>
    </div>
  </div>

  <!-- üîπ JS: ardƒ±cƒ±l se√ßm…ô + modal -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const branchSelect = document.getElementById("branchSelect");
      const staffSelect = document.getElementById("staffSelect");
      const serviceSelect = document.getElementById("serviceSelect");
      const hiddenBranch = document.getElementById("branchIdHidden");
      const hiddenStaff = document.getElementById("staffIdHidden");
      const hiddenService = document.getElementById("serviceIdHidden");

      // üîπ Filial se√ßil…ônd…ô ustalar
      branchSelect.addEventListener("change", async () => {
        const branchId = branchSelect.value;
        hiddenBranch.value = branchId;
        staffSelect.innerHTML = '<option value="">Se√ßin...</option>';
        serviceSelect.innerHTML = '<option value="">Se√ßin...</option>';
        staffSelect.disabled = !branchId;
        serviceSelect.disabled = true;

        if (branchId) {
          const res = await fetch(`/booking/staff-by-branch/${branchId}`);
          const data = await res.json();
          data.forEach(st => {
            const opt = document.createElement("option");
            opt.value = st.id;
            opt.textContent = st.fullName;
            staffSelect.appendChild(opt);
          });
        }
      });

      // üîπ Usta se√ßil…ônd…ô xidm…ôtl…ôr
      staffSelect.addEventListener("change", async () => {
        const staffId = staffSelect.value;
        hiddenStaff.value = staffId;
        serviceSelect.innerHTML = '<option value="">Se√ßin...</option>';
        serviceSelect.disabled = !staffId;

        if (staffId) {
          const res = await fetch(`/booking/services-by-staff/${staffId}`);
          const data = await res.json();
          data.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.id;
            opt.textContent = s.name;
            serviceSelect.appendChild(opt);
          });
        }
      });

      // üîπ Xidm…ôt se√ßil…ônd…ô gizli input
      serviceSelect.addEventListener("change", () => {
        hiddenService.value = serviceSelect.value;
      });

      // üîπ ke√ßmi≈ü tarixl…ôr…ô icaz…ô verm…ô
      const dateInput = document.getElementById("dateInput");
      if (dateInput) {
        const today = new Date().toISOString().split("T")[0];
        dateInput.min = today;
      }

      // üîπ Uƒüur mesajƒ± varsa modal a√ß
      const successFlag = document.getElementById("successFlag");
      if (successFlag) {
        const modal = new bootstrap.Modal(document.getElementById('successModal'));
        modal.show();
        // 3 saniy…ô sonra avtomatik baƒülansƒ±n
        setTimeout(() => modal.hide(), 3000);
      }
    });
  </script>

</main>
</body>
</html>
