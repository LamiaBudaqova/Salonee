<!DOCTYPE html>
<html lang="az"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<body>
<main layout:fragment="content">

  <div class="container-fluid bg-light page-header py-5 mb-5">
    <div class="container text-center py-5">
      <h1 class="display-1">Rezervasiya</h1>
    </div>
  </div>

  <div class="container py-5">
    <div class="text-center mb-5">
      <h4 class="text-primary font-dancing-script">Ziyar…ôtinizi planla≈üdƒ±rƒ±n</h4>
      <h1 class="mb-0">Online rezervasiya edin</h1>
    </div>

    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8 col-sm-10">

        <!-- Error mesajƒ± -->
        <div th:if="${error}" class="alert alert-danger text-center mb-4"
             th:text="${error}"></div>

        <!-- Uƒüur flagƒ± (modal trigger) -->
        <div th:if="${success}" id="successFlag"></div>

        <form th:action="@{/booking}" th:object="${reservation}" method="post"
              class="p-4 border rounded bg-light shadow-sm">

          <!-- Filial se√ß -->
          <div class="mb-3">
            <label class="form-label fw-bold">Filial se√ßin</label>
            <select id="branchSelect" class="form-select" required>
              <option value="">Se√ßin...</option>
              <option th:each="b : ${branches}" th:value="${b.id}" th:text="${b.name}"></option>
            </select>
          </div>

          <!-- Usta se√ß -->
          <div class="mb-3">
            <label class="form-label fw-bold">Usta se√ßin</label>
            <select id="staffSelect" class="form-select" disabled required>
              <option value="">Se√ßin...</option>
            </select>
          </div>

          <!-- Xidm…ôt se√ß -->
          <div class="mb-3">
            <label class="form-label fw-bold">Xidm…ôt se√ßin</label>
            <select id="serviceSelect" class="form-select" disabled required>
              <option value="">Se√ßin...</option>
            </select>
          </div>

          <!-- Tarix -->
          <div class="mb-3">
            <label class="form-label fw-bold">Tarix</label>
            <input type="date" id="dateInput" th:field="*{date}" class="form-control" required>
          </div>

          <!-- Vaxt -->
          <div class="mb-3">
            <label class="form-label fw-bold">Vaxt</label>
            <input type="time" th:field="*{startTime}" class="form-control" required>
          </div>

          <!-- M√º≈üt…ôri m…ôlumatlarƒ± -->
          <div class="mb-3">
            <label class="form-label fw-bold">Ad v…ô Soyad</label>
            <input type="text" th:field="*{customerName}" class="form-control"
                   placeholder="M…ôs: Lamiy…ô Budaqova" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Telefon</label>
            <input type="text" th:field="*{customerPhone}" class="form-control"
                   placeholder="+994..." required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">∆èlav…ô qeyd</label>
            <textarea th:field="*{notes}" class="form-control" rows="3"
                      placeholder="∆èlav…ô ist…ôk v…ô ya qeyd..."></textarea>
          </div>

          <!-- Cashback yalnƒ±z login olanlara -->
          <div class="mb-3" th:if="${loggedUser != null}">
            <label class="form-label fw-bold d-block">Cashback istifad…ô et</label>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" th:field="*{useCashback}">
              <label class="form-check-label">
                M√∂vcud balans: <span th:text="${loggedUser.cashbackBalance}"></span> ‚Çº
              </label>
            </div>

            <small class="text-muted">
              Cashback yalnƒ±z daxil olmu≈ü istifad…ô√ßil…ôr √º√ß√ºn ke√ß…ôrlidir.
            </small>
          </div>

          <!-- Hidden inputlar -->
          <input type="hidden" th:field="*{branchId}" id="branchIdHidden">
          <input type="hidden" th:field="*{staffId}" id="staffIdHidden">
          <input type="hidden" th:field="*{serviceId}" id="serviceIdHidden">

          <div class="text-center mt-4">
            <button class="btn btn-primary px-5 py-2" type="submit">
              <i class="bi bi-calendar-check me-2"></i>Rezerv et
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-success shadow">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Rezervasiya uƒüurlu</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body text-center">
          <i class="bi bi-check-circle-fill text-success" style="font-size: 48px;"></i>
          <p class="mt-3">Rezervasiyanƒ±z uƒüurla g√∂nd…ôrildi!</p>
          <p class="mt-2">
            Q…ôbul v…ô ya r…ôdd edildiyini √∂yr…ônm…ôk √º√ß√ºn
            <a href="https://t.me/lamiabeauty_bot" target="_blank" class="text-primary fw-bold">@lamiabeauty_bot</a>
            Telegram botuna yazƒ±n üí¨
          </p>
        </div>

        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-success px-4" data-bs-dismiss="modal">Baƒüla</button>
        </div>
      </div>
    </div>
  </div>

  <!-- =================== JS ==================== -->
  <script>

    // === Filial se√ßil…ônd…ô ustalarƒ± doldur ===
    document.getElementById("branchSelect").addEventListener("change", function () {
      let branchId = this.value;
      document.getElementById("branchIdHidden").value = branchId;

      if (!branchId) return;

      fetch(`/booking/staff-by-branch/${branchId}`)
              .then(res => res.json())
              .then(data => {
                let staffSelect = document.getElementById("staffSelect");
                staffSelect.innerHTML = '<option value="">Se√ßin...</option>';

                data.forEach(st => {
                  staffSelect.innerHTML += `<option value="${st.id}">${st.fullName}</option>`;
                });

                staffSelect.disabled = false;
              });
    });

    // === Usta se√ßil…ônd…ô xidm…ôtl…ôri doldur ===
    document.getElementById("staffSelect").addEventListener("change", function () {
      let staffId = this.value;
      document.getElementById("staffIdHidden").value = staffId;

      if (!staffId) return;

      fetch(`/booking/services-by-staff/${staffId}`)
              .then(res => res.json())
              .then(data => {
                let serviceSelect = document.getElementById("serviceSelect");
                serviceSelect.innerHTML = '<option value="">Se√ßin...</option>';

                data.forEach(s => {
                  serviceSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });

                serviceSelect.disabled = false;
              });
    });

    // === Hidden serviceId doldur ===
    document.getElementById("serviceSelect").addEventListener("change", function () {
      document.getElementById("serviceIdHidden").value = this.value;
    });

  </script>

  <!-- MODAL AUTO-SHOW FIX -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
        if (document.getElementById("successFlag")) {
            var modal = new bootstrap.Modal(document.getElementById("successModal"));
            modal.show();
        }
    });
  </script>

</main>
</body>
</html>
